<!DOCTYPE html>

{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Channels WebRTC</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
</head>
<body>
    <h3 id="label-username">USERNAME</h3>
    <div>
        <input id="username"><button id="btn-join">Join Room</button>
    </div>

    <div class="main-grid-container">
        <div id="video-container">
            <div><video id="local-video" style="float: left;" autoplay playsinline></video></div>
            <button id="btn-toggle-audio">Audio Mute</button>
            <button id="btn-toggle-video">video Off</button>
        </div>

        <div id="chat">
            <h3>CHAT</h3>
            <div id="messages">
                <ul id="message-list"></ul>
            </div>

            <div><input id="msg"><button id="btn-send-msg">Send Message</button></div>
            <button id="btn-share-screen">Share Screen</button>
        </div>
    </div>
    <div>
        <button id="move-forward">Move Forward</button>
        <button id="move-backward">Move Forward</button>
    </div>
    <div>
        <button id="start-record-btn">Rozpocznij nagrywanie</button>
        <button id="stop-record-btn" disabled>Zatrzymaj nagrywanie</button>
        <p id="recording-status"></p>
        <h2>Rozpoznany tekst:</h2>
        <p id="recognized-text"></p>
        <script>
            const startRecordBtn = document.getElementById('start-record-btn');
            const stopRecordBtn = document.getElementById('stop-record-btn');
            const recordingStatus = document.getElementById('recording-status');
            const recognizedText = document.getElementById('recognized-text');
    
            // Sprawdzenie dostępności Web Speech API
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Web Speech API nie jest wspierane w tej przeglądarce.');
            } else {
                const recognition = new SpeechRecognition();
                recognition.continuous = true; // Umożliwia ciągłe rozpoznawanie
                recognition.interimResults = true; // Umożliwia zwracanie wyników pośrednich
    
                recognition.onstart = function() {
                    recordingStatus.textContent = 'Nagrywanie...';
                };
    
                let lastIndexStart = 0;
                let lastIndexStop = 0;
    
                recognition.onresult = function(event) {
                    let interimTranscript = '';
    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            recognizedText.textContent += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
    
                            // Sprawdzanie i znajdowanie indeksu słowa "start" po ostatnim znalezionym indeksie
                            let indexStart = interimTranscript.toLowerCase().indexOf("start", lastIndexStart);
                            if (indexStart !== -1) {
                                console.log(`Słowo 'start' wykryto na indeksie ${indexStart}`);
                                lastIndexStart = indexStart + "start".length; // Ustawienie nowego startowego indeksu
                                sendToRobotForward();
                            }
    
                            // Sprawdzanie i znajdowanie indeksu słowa "stop" po ostatnim znalezionym indeksie
                            let indexStop = interimTranscript.toLowerCase().indexOf("stop", lastIndexStop);
                            if (indexStop !== -1) {
                                console.log(`Słowo 'stop' wykryto na indeksie ${indexStop}`);
                                lastIndexStop = indexStop + "stop".length; // Ustawienie nowego startowego indeksu
                                sendToRobotBackward();
                            }
                        }
                    }
                    
                    // Jeśli transcript jest pusty, zresetuj liczniki
                    if (interimTranscript.trim() === '') {
                        lastIndexStart = 0;
                        lastIndexStop = 0;
                    }
    
                    recordingStatus.textContent = 'Nagrywanie... (tymczasowy tekst: ' + interimTranscript + ')';
                };
    
                recognition.onerror = function(event) {
                    recordingStatus.textContent = 'Błąd w rozpoznawaniu mowy: ' + event.error;
                };
    
                recognition.onend = function() {
                    recordingStatus.textContent = 'Nagrywanie zakończone.';
                };
    
                startRecordBtn.onclick = function() {
                    recognition.start();
                    startRecordBtn.disabled = true;
                    stopRecordBtn.disabled = false;
                };
    
                stopRecordBtn.onclick = function() {
                    recognition.stop();
                    startRecordBtn.disabled = false;
                    stopRecordBtn.disabled = true;
                };
            }
        </script>
    </div>
    

    <script type="text/javascript" src="{% static 'js/main.js' %}"></script>
</body>
</html>